<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Audio Mixer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 32px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 24px;
            text-align: center;
            font-size: 28px;
        }
        .track {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #e9ecef;
        }
        .track h3 {
            color: #495057;
            margin-bottom: 12px;
            font-size: 16px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        .volume-value {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
            color: #495057;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }
        button {
            flex: 1;
            min-width: 0;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        #btn-start {
            background: #667eea;
            color: white;
        }
        #btn-start:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        #btn-stop {
            background: #dc3545;
            color: white;
        }
        #btn-stop:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status.idle { background: #e9ecef; color: #6c757d; }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.recording { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.success { background: #d1ecf1; color: #0c5460; }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-red {
            0% { background-color: #dc3545; box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { background-color: #ff4d5a; box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { background-color: #dc3545; box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .recording-active {
            animation: pulse-red 2s infinite;
            color: white !important;
            border: none !important;
        }
        .timer {
            text-align: center;
            margin: 15px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            background-color: #fff0f0;
            padding: 8px 5px;
            border-radius: 8px;
            border: 2px solid #ffc9c9;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-height: 45px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .timer.recording-bg {
            background-image: linear-gradient(
                45deg,
                rgba(255, 200, 200, 0.4) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 200, 200, 0.4) 50%,
                rgba(255, 200, 200, 0.4) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: move-stripe 2s linear infinite;
        }
        @keyframes move-stripe {
            from { background-position: 0 0; }
            to { background-position: 40px 0; }
        }
        .tab-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            font-size: 14px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .track-view {
            min-height: 250px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ YouTube Audio Mixer</h1>

        <div class="track" id="track1">
            <div class="tab-group">
                <button type="button" class="tab-btn active" id="btn-tab-monitor1" onclick="switchView(1, 'monitor')">üì∫ Monitor</button>
                <button type="button" class="tab-btn" id="btn-tab-playlist1" onclick="switchView(1, 'playlist')">üìù Playlist</button>
                <button type="button" class="tab-btn" id="btn-tab-eq1" onclick="switchView(1, 'eq')">üéõÔ∏èÔ∏è EQ</button>
            </div>

            <div id="view-monitor1" class="track-view">
                <input type="hidden" id="url1" value="">
                <h3 style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    Track 1 <span id="time1" style="font-family: monospace; font-size: 18px; color: #666;">00:00:00</span>
                </h3>
                
                <div style="background: #e9ecef; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; text-align: center;">
                    <span style="font-size: 12px; color: #6c757d; font-weight: 500;">Repeat: </span>
                    <span id="repeatStatus1" style="font-size: 12px; font-weight: bold; color: #495057;">No Repeat</span>
                </div>
                
                <video id="v1" width="100%" height="auto" style="border-radius: 8px; background: #000; margin-bottom: 12px; display: block;" crossorigin="anonymous" playsinline muted></video>

                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" id="playPause1" onclick="toggleTrackPlay(1)" style="background: #007bff; color: white; flex:1;">Play</button>
                    <button type="button" onclick="resetTrack(1)" style="background: #6c757d; color: white; flex:1;">Reset</button>
                    <button type="button" id="mute1" onclick="toggleMute(1)" style="background: #6c757d; color: white; flex:1;">Mute</button>
                </div>

                <div style="margin-top:12px;">
                    <label>Start Time (Offset) - seconds</label>
                    <input type="number" id="start1" value="0" min="0" step="0.1" style="width:100%; margin-bottom: 12px;">
                </div>

                <div style="margin-top:12px;">
                    <label>Volume</label>
                    <div class="volume-control">
                        <input type="range" id="vol1" min="0" max="1" step="0.01" value="1">
                        <span class="volume-value" id="vol1-value">100%</span>
                    </div>
                </div>
            </div>

            <div id="view-playlist1" class="track-view" style="display: none;">
                <label>Add YouTube URL</label>
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="urlInput1" placeholder="https://..." style="flex: 1; margin: 0;">
                    <button type="button" onclick="addToList(1)" style="background: #28a745; color: white; flex: 0 0 70px; border-radius:8px;">Add</button>
                </div>
                <ul id="playlist1" style="list-style: none; padding: 0; max-height: 180px; overflow-y: auto; background: #eee; border-radius: 8px; min-height: 50px; margin-bottom: 10px;"></ul>
                
                <div style="padding-top: 10px; border-top: 1px solid #eee;">
                    <label style="font-weight: bold; margin-bottom: 8px; display: block;">Repeat Mode:</label>
                    <label style="display:block; margin-bottom:5px; cursor: pointer;">
                        <input type="radio" name="repeatMode1" value="none" checked onchange="updateRepeatMode(1)"> No Repeat
                    </label>
                    <label style="display:block; margin-bottom:5px; cursor: pointer;">
                        <input type="radio" name="repeatMode1" value="item" onchange="updateRepeatMode(1)"> üîÇ Item Repeat (Loop current clip)
                    </label>
                    <label style="display:block; cursor: pointer;">
                        <input type="radio" name="repeatMode1" value="list" onchange="updateRepeatMode(1)"> üîÅ List Repeat (Loop entire playlist)
                    </label>
                </div>
            </div>

            <div id="view-eq1" class="track-view" style="display: none;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <label style="display:flex; justify-content:space-between;">BASS <span id="eq-low-val1">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%; margin-bottom: 15px;" oninput="updateEQ(1, 'low', this.value)">

                    <label style="display:flex; justify-content:space-between;">MID <span id="eq-mid-val1">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%; margin-bottom: 15px;" oninput="updateEQ(1, 'mid', this.value)">

                    <label style="display:flex; justify-content:space-between;">TREBLE <span id="eq-high-val1">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%;" oninput="updateEQ(1, 'high', this.value)">
                </div>
            </div>
        </div>

        <div class="track" id="track2">
            <div class="tab-group">
                <button type="button" class="tab-btn active" id="btn-tab-monitor2" onclick="switchView(2, 'monitor')">üì∫ Monitor</button>
                <button type="button" class="tab-btn" id="btn-tab-playlist2" onclick="switchView(2, 'playlist')">üìù Playlist</button>
                <button type="button" class="tab-btn" id="btn-tab-eq2" onclick="switchView(2, 'eq')">üéõÔ∏è EQ</button>
            </div>

            <div id="view-monitor2" class="track-view">
                <input type="hidden" id="url2" value="">
                <h3 style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    Track 2 <span id="time2" style="font-family: monospace; font-size: 18px; color: #666;">00:00:00</span>
                </h3>
                
                <div style="background: #e9ecef; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; text-align: center;">
                    <span style="font-size: 12px; color: #6c757d; font-weight: 500;">Repeat: </span>
                    <span id="repeatStatus2" style="font-size: 12px; font-weight: bold; color: #495057;">No Repeat</span>
                </div>
                
                <video id="v2" width="100%" height="auto" style="border-radius: 8px; background: #000; margin-bottom: 12px; display: block;" crossorigin="anonymous" playsinline muted></video>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" id="playPause2" onclick="toggleTrackPlay(2)" style="background: #007bff; color: white; flex:1;">Play</button>
                    <button type="button" onclick="resetTrack(2)" style="background: #6c757d; color: white; flex:1;">Reset</button>
                    <button type="button" id="mute2" onclick="toggleMute(2)" style="background: #6c757d; color: white; flex:1;">Mute</button>
                </div>
                
                <div style="margin-top:12px;">
                    <label>Start Time (Offset) - seconds</label>
                    <input type="number" id="start2" value="0" min="0" step="0.1" style="width:100%; margin-bottom: 12px;">
                </div>
                
                <div style="margin-top:12px;">
                    <label>Volume</label>
                    <div class="volume-control">
                        <input type="range" id="vol2" min="0" max="1" step="0.01" value="1">
                        <span class="volume-value" id="vol2-value">100%</span>
                    </div>
                </div>
            </div>

            <div id="view-playlist2" class="track-view" style="display: none;">
                <label>Add YouTube URL</label>
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="urlInput2" placeholder="https://..." style="flex: 1; margin: 0;">
                    <button type="button" onclick="addToList(2)" style="background: #28a745; color: white; flex: 0 0 70px; border-radius:8px;">Add</button>
                </div>
                <ul id="playlist2" style="list-style: none; padding: 0; max-height: 180px; overflow-y: auto; background: #eee; border-radius: 8px; min-height: 50px; margin-bottom: 10px;"></ul>
                
                <div style="padding-top: 10px; border-top: 1px solid #eee;">
                    <label style="font-weight: bold; margin-bottom: 8px; display: block;">Repeat Mode:</label>
                    <label style="display:block; margin-bottom:5px; cursor: pointer;">
                        <input type="radio" name="repeatMode2" value="none" checked onchange="updateRepeatMode(2)"> No Repeat
                    </label>
                    <label style="display:block; margin-bottom:5px; cursor: pointer;">
                        <input type="radio" name="repeatMode2" value="item" onchange="updateRepeatMode(2)"> üîÇ Item Repeat (Loop current clip)
                    </label>
                    <label style="display:block; cursor: pointer;">
                        <input type="radio" name="repeatMode2" value="list" onchange="updateRepeatMode(2)"> üîÅ List Repeat (Loop entire playlist)
                    </label>
                </div>
            </div>

            <div id="view-eq2" class="track-view" style="display: none;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <label style="display:flex; justify-content:space-between;">BASS <span id="eq-low-val2">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%; margin-bottom: 15px;" oninput="updateEQ(2, 'low', this.value)">
                    <label style="display:flex; justify-content:space-between;">MID <span id="eq-mid-val2">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%; margin-bottom: 15px;" oninput="updateEQ(2, 'mid', this.value)">
                    <label style="display:flex; justify-content:space-between;">TREBLE <span id="eq-high-val2">0dB</span></label>
                    <input type="range" min="-15" max="15" value="0" style="width: 100%;" oninput="updateEQ(2, 'high', this.value)">
                </div>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="controls">
                    <button id="btn-start">Start Recording</button>
                    <button id="btn-rec-pause" disabled style="background: #fd7e14; color: #fff;">REC Pause</button>
                    <button id="btn-pause" disabled style="background: #ffc107; color: #000;">Pause</button>
                    <button id="btn-stop" disabled>Stop & Save</button>
                    <button id="btn-cancel" disabled>Cancel</button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button type="button" onclick="playAllTracks()" style="background: #007bff; color: white;">‚ñ∂ Play All Tracks</button>
                </div>

                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>Master Vol:</label>
                    <input type="range" id="masterVol" min="0" max="1.5" step="0.01" value="1.0" style="width: 350px;">
                    <span id="masterVol-value">100%</span>
                </div>

                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="downloadWebM" checked> Download WebM (for check)
                </label>
            </div>

            <button onclick="toggleMasterEQ()" id="btn-master-eq" style="margin-top: 10px; background: #6c757d; color: white; width: 100%;">üéöÔ∏è Master EQ</button>
        </div>

        <!-- LiveStream Panel -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
            <h3 style="margin-bottom: 10px; color: #495057; font-size: 16px;">üì° LiveStream to YouTube</h3>
            
            <div style="margin-bottom: 10px;">
                <label>RTMP URL (YouTube Stream Key)</label>
                <input type="text" id="rtmpUrl" placeholder="rtmp://a.rtmp.youtube.com/live2/xxxx-xxxx-xxxx-xxxx" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; font-family: monospace;">
                <p style="font-size: 10px; color: #dc3545; margin: 3px 0 0 0;">‚ö†Ô∏è Must start with <code>rtmp://</code></p>
            </div>
            
            <div style="margin-bottom: 10px;">
                <label style="font-weight: bold; margin-bottom: 5px; display: block;">Video Source:</label>
                <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
                    <input type="radio" name="videoSource" value="1" checked> Track 1
                </label>
                <label style="display: inline-block; cursor: pointer;">
                    <input type="radio" name="videoSource" value="2"> Track 2
                </label>
                <p style="font-size: 11px; color: #6c757d; margin: 5px 0 0 0;">Audio will always be from Master output (both tracks mixed)</p>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button id="btn-livestream-start" onclick="startLiveStream()" style="flex: 1; background: #e74c3c; color: white; padding: 10px; border-radius: 8px; font-weight: bold;">üî¥ Start LiveStream</button>
                <button id="btn-livestream-stop" onclick="stopLiveStream()" disabled style="flex: 1; background: #95a5a6; color: white; padding: 10px; border-radius: 8px; font-weight: bold;">‚èπ Stop LiveStream</button>
            </div>
            
            <div id="livestream-status" style="margin-top: 10px; padding: 8px; border-radius: 4px; background: #ecf0f1; text-align: center; font-size: 12px; color: #7f8c8d;">
                Idle
            </div>
        </div>

        <!-- Master EQ Panel (12-Band) -->
        <div id="master-eq-panel" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
            <h3 style="text-align: center; margin-bottom: 15px;">Master EQ (12-Band)</h3>
            <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 4px; padding: 20px 10px; background: white; border-radius: 8px; overflow-x: auto;">
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-0" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(0, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">20Hz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-1" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(1, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">60Hz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-2" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(2, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">170Hz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-3" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(3, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">310Hz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-4" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(4, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">600Hz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-5" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(5, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">1kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-6" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(6, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">3kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-7" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(7, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">6kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-8" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(8, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">12kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-9" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(9, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">14kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-10" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(10, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">16kHz</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                    <span id="meq-11" style="font-size: 10px; margin: 3px 0;">0dB</span>
                    <input type="range" min="-15" max="15" value="0" step="0.5" onchange="updateMasterEQ(11, this.value)" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100px; height: 6px;">
                    <span style="font-size: 10px; margin: 3px 0;">20kHz</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button onclick="resetMasterEQ()" style="background: #6c757d; color: white; padding: 8px 20px; border: none; border-radius: 8px; cursor: pointer;">Reset to Flat</button>
            </div>
        </div>

        <div class="timer" id="timer"></div>
        <div class="status idle" id="status">Ready to record</div>
        <div id="download-container" style="margin-top: 15px; text-align: center;"></div>
    </div>

    <script>
        let audioCtx, masterDest, recorder, chunks;
        let timerInterval = null;
        let recordingStartTime = null;
        let masterSecondsElapsed = 0;
        const tracks = [];

        function switchView(trackId, mode) {
            const modes = ['monitor', 'playlist', 'eq'];
            modes.forEach(m => {
                const view = document.getElementById(`view-${m}${trackId}`);
                const btn = document.getElementById(`btn-tab-${m}${trackId}`);
                if (view) {
                    view.style.display = (m === mode) ? 'block' : 'none';
                }
                if (btn) {
                    if (m === mode) {
                        btn.style.background = "#667eea";
                        btn.style.color = "white";
                    } else {
                        btn.style.background = "#e9ecef";
                        btn.style.color = "#333";
                    }
                }
            });
        }

        function addToList(trackId) {
            const input = document.getElementById(`urlInput${trackId}`);
            const url = input.value.trim();
            if (!url) return;

            if (!tracks[trackId - 1]) {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    masterDest = audioCtx.createMediaStreamDestination();
                }
                tracks[trackId - 1] = new Track(audioCtx, masterDest, trackId);
            }

            const track = tracks[trackId - 1];
            track.playlist.push({ url: url, startTime: 0 });
            input.value = '';

            renderPlaylistUI(trackId);
        }

        function renderPlaylistUI(trackId) {
            const track = tracks[trackId - 1];
            if (!track) return;
            
            const ul = document.getElementById(`playlist${trackId}`);

            ul.innerHTML = track.playlist.map((item, index) => `
                <li style="display: flex; align-items: center; gap: 5px; padding: 10px; border-bottom: 1px solid #ddd; background: ${index === track.currentIndex ? '#d1ecf1' : 'transparent'};">
                    <span style="flex: 1; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;" onclick="loadFromPlaylist(${trackId}, ${index})">
                        ${index + 1}. ${item.url}
                    </span>
                    <div style="display: flex; gap: 2px;">
                        <button onclick="loadFromPlaylist(${trackId}, ${index})" style="background: #28a745; color: white; padding: 5px 8px; font-size: 10px;">üìºLoad</button>
                        <button onclick="moveItem(${trackId}, ${index}, -1)" style="padding: 5px 8px; font-size: 10px;">‚ñ≤</button>
                        <button onclick="moveItem(${trackId}, ${index}, 1)" style="padding: 5px 8px; font-size: 10px;">‚ñº</button>
                        <button onclick="removeFromList(${trackId}, ${index})" style="background: #dc3545; color: white; padding: 5px 8px; font-size: 10px;">√ó</button>
                    </div>
                </li>
            `).join('');
        }

        async function loadFromPlaylist(trackId, index, autoPlay = false) {
            const track = tracks[trackId - 1];
            if (!track) return;

            if (index >= track.playlist.length) {
                console.log("Playlist ended.");
                return;
            }

            const item = track.playlist[index];
            track.currentIndex = index;

            const mainUrlInput = document.getElementById(`url${trackId}`);
            if (mainUrlInput) mainUrlInput.value = item.url;

            try {
                await track.load();
                renderPlaylistUI(trackId);

                if (autoPlay) {
                    await track.video.play();
                } else {
                    switchView(trackId, 'monitor');
                }
            } catch (e) {
                console.warn(`Load failed for index ${index}: ${item.url}. Skipping to next...`);

                if (index < track.playlist.length - 1) {
                    setTimeout(() => {
                        loadFromPlaylist(trackId, index + 1, autoPlay);
                    }, 1000);
                } else {
                    setStatus(`Track ${trackId}: All items failed or ended`, 'error');
                }
            }
        }

        function moveItem(trackId, index, direction) {
            const track = tracks[trackId - 1];
            if (!track) return;
            
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= track.playlist.length) return;

            const element = track.playlist.splice(index, 1)[0];
            track.playlist.splice(newIndex, 0, element);

            if (track.currentIndex === index) {
                track.currentIndex = newIndex;
            }

            renderPlaylistUI(trackId);
        }

        function removeFromList(trackId, index) {
            const track = tracks[trackId - 1];
            if (!track) return;
            
            track.playlist.splice(index, 1);

            if (track.currentIndex >= track.playlist.length) {
                track.currentIndex = Math.max(0, track.playlist.length - 1);
            }

            renderPlaylistUI(trackId);
        }

        function toggleMute(id) {
            if (tracks[id - 1]) tracks[id - 1].toggleMute();
        }

        function toggleTrackPlay(id) {
            const target = tracks[id - 1];
            if (target) {
                target.togglePlay();
            } else {
                alert(`Track ${id} „ÇíÂÖà„Å´ Set & Load „Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            }
        }

        function resetTrack(id) {
            const target = tracks[id - 1];
            if (target) {
                target.stopAndReset();
            }
        }

        function updateRepeatMode(trackId) {
            updateRepeatStatus(trackId);
        }

        function updateRepeatStatus(trackId) {
            const track = tracks[trackId - 1];
            if (!track) return;

            const repeatMode = track.getRepeatMode();
            const statusElement = document.getElementById(`repeatStatus${trackId}`);
            
            if (!statusElement) return;

            switch(repeatMode) {
                case 'item':
                    statusElement.textContent = 'üîÇ Item Repeat';
                    statusElement.style.color = '#0066cc';
                    break;
                case 'list':
                    statusElement.textContent = 'üîÅ List Repeat';
                    statusElement.style.color = '#28a745';
                    break;
                default:
                    statusElement.textContent = 'No Repeat';
                    statusElement.style.color = '#495057';
            }
        }

        // Track EQ (3-band) update function
        function updateEQ(trackId, band, value) {
            const track = tracks[trackId - 1];
            if (!track || !track.filters) return;

            const val = parseFloat(value);
            const filter = track.filters[band];
            if (filter) {
                filter.gain.setTargetAtTime(val, audioCtx.currentTime, 0.01);
                const display = document.getElementById(`eq-${band}-val${trackId}`);
                if (display) display.textContent = (val > 0 ? '+' : '') + val + 'dB';
            }
        }

        // Master EQ (12-band) update function
        function updateMasterEQ(index, value) {
            if (!masterEQFilters[index]) return;
            const val = parseFloat(value);
            masterEQFilters[index].gain.setTargetAtTime(val, audioCtx.currentTime, 0.01);
            const display = document.getElementById(`meq-${index}`);
            if (display) display.textContent = (val > 0 ? '+' : '') + val + 'dB';
        }

        function resetMasterEQ() {
            masterEQFilters.forEach((filter, i) => {
                filter.gain.setTargetAtTime(0, audioCtx.currentTime, 0.01);
                const slider = document.querySelector(`#master-eq-panel .eq-band:nth-child(${i + 1}) input`);
                if (slider) slider.value = 0;
                updateMasterEQ(i, 0);
            });
        }

        function toggleMasterEQ() {
            const panel = document.getElementById('master-eq-panel');
            const btn = document.getElementById('btn-master-eq');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.style.background = '#667eea';
            } else {
                panel.style.display = 'none';
                btn.style.background = '#6c757d';
            }
        }

        class Track {
            constructor(ctx, dest, trackNum) {
                this.ctx = ctx;
                this.dest = dest;
                this.id = trackNum;
                this.video = document.getElementById(`v${this.id}`);
                this.volInput = document.getElementById(`vol${this.id}`);
                this.timeDisplay = document.getElementById(`time${this.id}`);
                this.playlist = [];
                this.currentIndex = 0;
                this.lastPos = 0;
                this.source = null;
                this.gain = null;
                this.isMuted = false;
                this.timerId = null;
                this.secondsElapsed = 0;
                this.btnPlayPause = document.getElementById(`playPause${this.id}`);
                this.repeatMode = 'none';
            }

            getRepeatMode() {
                const radios = document.getElementsByName(`repeatMode${this.id}`);
                for (const radio of radios) {
                    if (radio.checked) {
                        return radio.value;
                    }
                }
                return 'none';
            }

            resetToLastPos() {
                this.video.pause();
                const offsetTime = parseFloat(document.getElementById(`start${this.id}`).value) || 0;
                this.video.currentTime = offsetTime;
                this.stopTimer();
                this.timeDisplay.innerText = this.formatTime(offsetTime);
                if (this.btnPlayPause) this.btnPlayPause.innerText = "Play";
            }

            async togglePlay() {
                if (!this.video.src) return;

                if (this.video.paused) {
                    this.lastPos = this.video.currentTime;
                    await this.video.play();
                    if (this.btnPlayPause) this.btnPlayPause.innerText = "Pause";
                } else {
                    this.video.pause();
                    if (this.btnPlayPause) this.btnPlayPause.innerText = "Play";
                }
            }

            stopAndReset() {
                this.video.pause();
                const offsetTime = parseFloat(document.getElementById(`start${this.id}`).value) || 0;
                this.video.currentTime = offsetTime;
                this.stopTimer();
                this.timeDisplay.innerText = this.formatTime(this.video.currentTime);
                if (this.btnPlayPause) this.btnPlayPause.innerText = "Play";
            }

            setupNodes() {
                if (!this.source) {
                    setupMasterChain();

                    this.source = this.ctx.createMediaElementSource(this.video);

                    // Track EQ (3-band)
                    this.filters = {};
                    this.filters.low = this.ctx.createBiquadFilter();
                    this.filters.low.type = 'lowshelf';
                    this.filters.low.frequency.value = 320;
                    this.filters.low.gain.value = 0;

                    this.filters.mid = this.ctx.createBiquadFilter();
                    this.filters.mid.type = 'peaking';
                    this.filters.mid.frequency.value = 1000;
                    this.filters.mid.Q.value = 1.0;
                    this.filters.mid.gain.value = 0;

                    this.filters.high = this.ctx.createBiquadFilter();
                    this.filters.high.type = 'highshelf';
                    this.filters.high.frequency.value = 3200;
                    this.filters.high.gain.value = 0;

                    // Track Gain
                    this.gain = this.ctx.createGain();
                    this.gain.gain.value = this.volInput.value;

                    // Connect: source -> low -> mid -> high -> gain -> masterEQ[0]
                    this.source.connect(this.filters.low);
                    this.filters.low.connect(this.filters.mid);
                    this.filters.mid.connect(this.filters.high);
                    this.filters.high.connect(this.gain);
                    this.gain.connect(masterEQFilters[0]);

                    this.volInput.oninput = () => {
                        const val = parseFloat(this.volInput.value);

                        if (!this.isMuted) {
                            this.gain.gain.setTargetAtTime(val, this.ctx.currentTime, 0.01);
                        }

                        const display = document.getElementById(`vol${this.id}-value`);
                        if (display) {
                            display.textContent = Math.round(val * 100) + '%';
                        }
                    };
                }
            }

            async load() {
                this.setupNodes(); // EQ„Éé„Éº„Éâ„Å®„Ç™„Éº„Éá„Ç£„Ç™„Ç∞„É©„Éï„ÇíÂàùÊúüÂåñ
                
                const url = document.getElementById(`url${this.id}`).value;
                const startTime = document.getElementById(`start${this.id}`).value || 0;
                if (!url) return;

                this.stopTimer();
                this.secondsElapsed = 0;
                this.timeDisplay.innerText = "00:00:00";

                const proxyUrl = `/audio?url=${encodeURIComponent(url)}&start=${startTime}&format=mp4&repeat=false`;
                this.video.src = proxyUrl;
                this.video.muted = false;

                this.video.onplay = () => this.startTimer();
                this.video.onpause = () => this.stopTimer();
                
                this.video.onended = () => {
                    this.stopTimer();

                    const repeatMode = this.getRepeatMode();

                    if (repeatMode === 'item') {
                        this.restart();
                    } else if (this.currentIndex < this.playlist.length - 1) {
                        this.currentIndex++;
                        loadFromPlaylist(this.id, this.currentIndex, true);
                    } else if (repeatMode === 'list') {
                        this.currentIndex = 0;
                        loadFromPlaylist(this.id, this.currentIndex, true);
                    } else {
                        this.stopAndReset();
                    }
                };

                return new Promise((resolve, reject) => {
                    this.video.onloadeddata = () => {
                        this.video.currentTime = parseFloat(startTime) || 0;
                        resolve();
                    };

                    this.video.onerror = () => {
                        reject(new Error("Video element error"));
                    };

                    setTimeout(() => reject(new Error("Timeout")), 15000);

                    this.video.load();
                });
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById(`mute${this.id}`);
                if (this.isMuted) {
                    this.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.01);
                    btn.innerText = "Unmute";
                    btn.style.background = "#dc3545";
                } else {
                    this.gain.gain.setTargetAtTime(this.volInput.value, this.ctx.currentTime, 0.01);
                    btn.innerText = "Mute";
                    btn.style.background = "#6c757d";
                }
            }

            startTimer() {
                this.stopTimer();

                const timeStr = this.timeDisplay.innerText.trim();
                const parts = timeStr.split(':').map(Number);
                let currentSeconds = 0;

                if (parts.length === 3) {
                    currentSeconds = (parts[0] * 3600) + (parts[1] * 60) + parts[2];
                } else if (parts.length === 2) {
                    currentSeconds = (parts[0] * 60) + parts[1];
                }

                const startTimeAtClick = Date.now();
                this.secondsElapsed = currentSeconds;

                this.timerId = setInterval(() => {
                    if (this.video && !this.video.paused) {
                        const now = Date.now();
                        const sessionSeconds = Math.floor((now - startTimeAtClick) / 1000);
                        this.secondsElapsed = currentSeconds + sessionSeconds;
                        this.timeDisplay.innerText = this.formatTime(this.secondsElapsed);
                    }
                }, 200);
            }

            stopTimer() {
                if (this.timerId) {
                    clearInterval(this.timerId);
                    this.timerId = null;
                }
            }

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                if (h > 0) {
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }
                return `00:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            async restart() {
                this.video.currentTime = 0;
                this.secondsElapsed = 0;
                this.timeDisplay.innerText = "00:00:00";
                try {
                    await this.video.play();
                } catch (e) {
                    console.error("Restart failed", e);
                }
            }

            stop() {
                this.video.pause();
                this.stopTimer();
            }
        }

        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const btnCancel = document.getElementById('btn-cancel');
        const status = document.getElementById('status');
        const btnPause = document.getElementById('btn-pause');
        const btnRecPause = document.getElementById('btn-rec-pause');

        let masterGain = null;
        let masterEQFilters = [];
        const masterEQFreqs = [20, 60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000, 20000];

        function setupMasterChain() {
            if (masterGain || !audioCtx) return;

            // Master EQ Filters (12-band)
            masterEQFilters = masterEQFreqs.map(freq => {
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'peaking';
                filter.frequency.value = freq;
                filter.Q.value = 1.0;
                filter.gain.value = 0;
                return filter;
            });

            // Master Gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 1.0;

            // Connect: EQ[0] -> EQ[1] -> ... -> EQ[11] -> masterGain -> destination
            // EQ chain connection
            for (let i = 0; i < masterEQFilters.length - 1; i++) {
                masterEQFilters[i].connect(masterEQFilters[i + 1]);
            }
            
            // Last EQ -> Master Gain -> outputs
            const lastEQ = masterEQFilters[masterEQFilters.length - 1];
            lastEQ.connect(masterGain);
            masterGain.connect(audioCtx.destination);
            masterGain.connect(masterDest);

            const mVol = document.getElementById('masterVol');
            const mVolVal = document.getElementById('masterVol-value');

            const initialVal = parseFloat(mVol.value);
            masterGain.gain.setValueAtTime(initialVal, audioCtx.currentTime);
            if (mVolVal) mVolVal.textContent = Math.round(initialVal * 100) + '%';

            mVol.oninput = () => {
                const val = parseFloat(mVol.value);
                masterGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.01);
                if (mVolVal) {
                    mVolVal.textContent = Math.round(val * 100) + '%';
                }
            };
        }

        let isPlayingAll = false;

        function playAllTracks() {
            const btnPlayAll = document.querySelector('button[onclick="playAllTracks()"]');

            if (!isPlayingAll) {
                if (tracks.length === 0 || tracks.every(t => !t || !t.video.src)) {
                    return setStatus("No tracks loaded", "error");
                }

                isPlayingAll = true;
                btnPlayAll.innerText = "‚ñ† All Stop";
                btnPlayAll.style.background = "#dc3545";

                tracks.forEach(t => {
                    if (t && t.video) {
                        t.lastPos = t.video.currentTime;
                    }
                });

                tracks.forEach(t => {
                    if (t && t.video.src) {
                        t.video.play();
                        t.startTimer();
                        if (t.btnPlayPause) t.btnPlayPause.innerText = "Pause";
                    }
                });
                startMasterTimer();

                btnStart.disabled = true;
                btnPause.disabled = false;
                setStatus("Monitoring: All tracks playing", "success");

            } else {
                stopEverything();
                tracks.forEach(t => {
                    if (t) t.resetToLastPos();
                });
            }
        }

        function stopEverything() {
            isPlayingAll = false;

            const btnPlayAll = document.querySelector('button[onclick="playAllTracks()"]');
            if (btnPlayAll) {
                btnPlayAll.innerText = "‚ñ∂ Play All Tracks";
                btnPlayAll.style.background = "#007bff";
            }

            tracks.forEach(t => {
                if (t) {
                    t.video.pause();
                    t.stopAndReset();
                    const startTime = parseFloat(document.getElementById(`start${t.id}`).value) || 0;
                    t.video.currentTime = startTime;
                    t.stopTimer();
                    t.secondsElapsed = 0;

                    const timeDisplay = document.getElementById(`time${t.id}`);
                    if (timeDisplay) timeDisplay.textContent = "00:00:00";
                }
            });

            if (timerInterval) clearInterval(timerInterval);
            masterSecondsElapsed = 0;

            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.innerHTML = `<span style="font-size: 14px; color: #999; vertical-align: middle;">REC</span> 00:00:00`;
            }

            if (recorder && recorder.state !== 'inactive') {
                recorder.stop();
            } else {
                setStatus("Stopped & Reset", "idle");
                btnStart.disabled = false;
                btnPause.disabled = true;
                btnPause.innerText = "Pause";
                btnPause.style.background = "#ffc107";
                btnPause.style.color = "#000";
            }
        }

        function setStatus(text, type = 'idle') {
            status.className = `status ${type}`;
            if (type === 'loading') {
                status.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                status.textContent = text;
            }
        }

        function startMasterTimer(forceReset = false) {
            if (timerInterval) clearInterval(timerInterval);

            const timerElement = document.getElementById('timer');
            let elapsedMs = 0;

            if (!forceReset) {
                const currentText = timerElement.textContent || "00:00:00";
                const timeMatch = currentText.match(/(\d+:)?(\d+):(\d+)/);

                if (timeMatch) {
                    const parts = timeMatch[0].split(':').map(Number);
                    if (parts.length === 3) {
                        elapsedMs = (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000;
                    } else if (parts.length === 2) {
                        elapsedMs = (parts[0] * 60 + parts[1]) * 1000;
                    }
                }
            }

            recordingStartTime = Date.now() - elapsedMs;

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
                const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(elapsed % 60).toString().padStart(2, '0');

                timerElement.innerHTML = `<span style="font-size: 14px; color: #999; vertical-align: middle;">REC</span> ${h}:${m}:${s}`;
            }, 200);
        }

        function cleanup() {
            tracks.forEach(t => {
                if (t && t.destroy) t.destroy();
            });
            tracks.length = 0;

            if (recorder && recorder.state !== 'inactive') {
                recorder.stop();
            }
            recorder = null;
            chunks = [];

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').textContent = '';
        }

        btnStart.onclick = async () => {
            try {
                const timerElement = document.getElementById('timer');
                timerElement.classList.add('recording-bg');
                btnStop.classList.add('recording-active');
                
                if (tracks.length === 0 || tracks.every(t => !t || !t.video.src)) {
                    throw new Error('Please Load at least one track first');
                }

                setStatus('Starting Recording...', 'loading');
                
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    masterDest = audioCtx.createMediaStreamDestination();
                }
                await audioCtx.resume();

                chunks = [];
                recorder = new MediaRecorder(masterDest.stream, { mimeType: 'audio/webm;codecs=opus' });
                recorder.ondataavailable = e => {
                    if (e.data.size > 0) chunks.push(e.data);
                };
                recorder.onstop = saveFile;

                tracks.forEach(t => {
                    if (t && t.video) {
                        t.lastPos = t.video.currentTime;
                    }
                });

                recorder.start();
                startMasterTimer(true);
                btnPause.disabled = false;
                btnRecPause.disabled = false;

                tracks.forEach(t => {
                    if (t && t.video.src) {
                        t.video.play();
                        if (t.btnPlayPause) t.btnPlayPause.innerText = "Pause";
                    }
                });

                setStatus('Recording...', 'recording');
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnCancel.disabled = false;

            } catch (error) {
                console.error('Start error:', error);
                setStatus(error.message, 'error');
            }
        };

        btnStop.onclick = () => {
            try {
                const timerElement = document.getElementById('timer');
                timerElement.classList.remove('recording-bg');
                btnStop.classList.remove('recording-active');

                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                if (recorder && recorder.state === 'recording') {
                    recorder.stop();
                }
                
                tracks.forEach(t => {
                    if (t) {
                        t.stop();
                        t.stopAndReset();
                    }
                });
                
                setStatus('Processing...', 'loading');
                btnStop.disabled = true;
                btnCancel.disabled = true;
            } catch (error) {
                console.error('Stop error:', error);
                setStatus('Failed to stop recording', 'error');
                cleanup();
                btnStart.disabled = false;
            }
        };

        btnCancel.onclick = () => {
            try {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                recordingStartTime = null;

                const btnPlayAll = document.querySelector('button[onclick="playAllTracks()"]');
                if (btnPlayAll) {
                    btnPlayAll.innerText = "‚ñ∂ Play All Tracks";
                    btnPlayAll.style.background = "#007bff";
                }
                isPlayingAll = false;

                const timerElement = document.getElementById('timer');
                timerElement.innerHTML = `<span style="font-size: 14px; color: #999; vertical-align: middle;">REC</span> 00:00:00`;
                timerElement.classList.remove('recording-bg');
                btnStop.classList.remove('recording-active');

                if (recorder) {
                    recorder.onstop = null;
                    if (recorder.state !== 'inactive') {
                        recorder.stop();
                    }
                }

                tracks.forEach(t => {
                    if (t) {
                        t.stop();
                        t.stopAndReset();
                        t.resetToLastPos();
                    }
                });

                cleanup();

                setStatus('Recording canceled.', 'idle');
                btnStart.disabled = false;
                btnStop.disabled = true;
                btnCancel.disabled = true;
                btnPause.disabled = true;
                btnRecPause.disabled = true;
                btnRecPause.innerText = "REC Pause";
                btnPause.innerText = "Pause";

            } catch (error) {
                console.error('Cancel error:', error);
                setStatus('Failed to cancel recording', 'error');
                btnStart.disabled = false;
            }
        };

        btnRecPause.onclick = () => {
            if (!recorder || recorder.state === 'inactive') return;

            if (recorder.state === 'recording') {
                recorder.pause();
                clearInterval(timerInterval);
                btnRecPause.innerText = "Resume REC";
                btnRecPause.style.background = "#28a745";
                setStatus("REC paused (video playing...)", "loading");
            } else if (recorder.state === 'paused') {
                recorder.resume();
                startMasterTimer();
                btnRecPause.innerText = "REC Pause";
                btnRecPause.style.background = "#fd7e14";
                setStatus("Recording...", "success");
            }
        };

        btnPause.onclick = () => {
            const isRecording = recorder && (recorder.state === 'recording' || recorder.state === 'paused');

            if (isRecording || isPlayingAll) {
                const isCurrentlyMoving = tracks.some(t => t && t.video && !t.video.paused);

                if (isCurrentlyMoving) {
                    tracks.forEach(t => {
                        if (t && t.video) {
                            t.video.pause();
                            if (t.btnPlayPause) t.btnPlayPause.innerText = "Play";
                            t.stopTimer();
                        }
                    });
                    
                    if (isRecording && recorder.state === 'recording') recorder.pause();

                    clearInterval(timerInterval);
                    timerInterval = null;
                    btnPause.innerText = "Resume";
                    setStatus("Paused", "loading");
                } else {
                    tracks.forEach(t => {
                        if (t && t.video) {
                            t.video.play().catch(e => console.warn("Playback prevented", e));
                            t.startTimer();
                            if (t.btnPlayPause) t.btnPlayPause.innerText = "Pause";
                        }
                    });

                    startMasterTimer(false);

                    btnPause.innerText = "Pause";
                    setStatus(isRecording ? "Recording..." : "Playing...", "success");
                }
            }
        };

        async function saveFile() {
            if (chunks.length === 0) {
                setStatus("No recording data", "error");
                return;
            }

            const blob = new Blob(chunks, { type: 'audio/webm' });
            const timestamp = Date.now();

            const shouldDownloadWebm = document.getElementById('downloadWebM')?.checked;
            if (shouldDownloadWebm) {
                const webmUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = webmUrl;
                a.download = `check_raw_${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(webmUrl), 1000);
            }

            setStatus("Uploading for MP3 conversion...", "loading");

            try {
                const formData = new FormData();
                formData.append('file', blob, `recording_${timestamp}.webm`);

                const response = await fetch('/convert/start', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server upload failed: ${errorText}`);
                }

                const { job_id } = await response.json();
                console.log("Conversion Job ID:", job_id);

                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`/convert/status/${job_id}`);
                        if (!statusRes.ok) return;

                        const data = await statusRes.json();

                        if (data.status === 'completed') {
                            clearInterval(pollInterval);
                            setStatus("MP3 Conversion Complete!", "success");

                            const container = document.getElementById('download-container');
                            const timestamp = new Date().toLocaleString();

                            container.innerHTML = `
                                <div style="padding: 15px; background: #fff; border: 2px solid #28a745; border-radius: 8px;">
                                    <p style="margin-bottom: 10px; font-weight: bold; color: #333;">Mixed MP3</p>
                                    <a href="${data.url}"
                                    download="mixed_recording_${Date.now()}.mp3"
                                    style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                                    Click to Download MP3
                                    </a>
                                    <p style="font-size: 10px; color: #666; margin-top: 8px;">Generated at: ${timestamp}</p>
                                </div>
                            `;

                            btnStart.disabled = false;

                        } else if (data.status === 'failed') {
                            clearInterval(pollInterval);
                            const msg = data.reason === 'timeout' ? "Timeout (Process too long)" : "Conversion failed";
                            setStatus(msg, "error");
                            btnStart.disabled = false;
                        } else {
                            setStatus(`Converting... (Job: ${job_id})`, "loading");
                        }
                    } catch (pollErr) {
                        console.error("Polling error:", pollErr);
                    }
                }, 2000);

            } catch (error) {
                console.error("Save error:", error);
                setStatus(`Error: ${error.message}`, "error");
                btnStart.disabled = false;
            }
        }

        window.addEventListener('beforeunload', (e) => {
            if (recorder && recorder.state === 'recording') {
                e.preventDefault();
                e.returnValue = '';
                return 'Recording in progress. Are you sure you want to leave?';
            }
        });

        // === LiveStream Functions ===
        let livestreamWS = null;
        let livestreamRecorder = null;
        let livestreamActive = false;

        async function startLiveStream() {
            const rtmpUrl = document.getElementById('rtmpUrl').value.trim();
            if (!rtmpUrl) {
                alert('Please enter RTMP URL');
                return;
            }
            
            // RTMP URLÊ§úË®º
            if (!rtmpUrl.startsWith('rtmp://') && !rtmpUrl.startsWith('rtmps://')) {
                alert('Invalid RTMP URL. Must start with rtmp:// or rtmps://\n\nExample: rtmp://a.rtmp.youtube.com/live2/your-stream-key');
                return;
            }

            const videoSource = document.querySelector('input[name="videoSource"]:checked').value;
            
            // AudioContext„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            if (!audioCtx || !masterDest) {
                alert('Please load at least one track before starting livestream');
                return;
            }
            
            try {
                // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÈñãÂßã„É™„ÇØ„Ç®„Çπ„Éà
                const response = await fetch('/livestream/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        rtmp_url: rtmpUrl,
                        video_track: parseInt(videoSource)
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start livestream');
                }

                // WebSocketÊé•Á∂öÔºàHTTP/HTTPSËá™ÂãïÂà§ÂÆöÔºâ
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/livestream/ws`;
                console.log('[LiveStream] Connecting to:', wsUrl);
                livestreamWS = new WebSocket(wsUrl);
                
                livestreamWS.onopen = async () => {
                    console.log('[LiveStream] WebSocket connected - Hybrid Mode');
                    
                    // ÈÅ∏Êäû„Åï„Çå„Åü„Éà„É©„ÉÉ„ÇØ„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
                    const selectedTrack = tracks[parseInt(videoSource) - 1];
                    
                    if (!selectedTrack || selectedTrack.playlist.length === 0) {
                        alert('Selected track has no playlist items');
                        stopLiveStream();
                        return;
                    }
                    
                    // „Éó„É¨„Ç§„É™„Çπ„ÉàÊÉÖÂ†±„ÇíBackend„Å´ÈÄÅ‰ø°
                    const playlistData = {
                        playlist: selectedTrack.playlist.map(item => item.url),
                        current_index: selectedTrack.currentIndex,
                        repeat_mode: selectedTrack.getRepeatMode()
                    };
                    
                    console.log('[LiveStream] Sending playlist:', playlistData);
                    livestreamWS.send(JSON.stringify(playlistData));
                    
                    // Master Audio„ÇíOpusÂΩ¢Âºè„Åß„Ç®„É≥„Ç≥„Éº„Éâ„Åó„Å¶ÈÄÅ‰ø°
                    const audioStream = masterDest.stream;
                    
                    try {
                        // MediaRecorder„ÅßMaster Audio„ÇíOpus„Å´„Ç®„É≥„Ç≥„Éº„Éâ
                        livestreamRecorder = new MediaRecorder(audioStream, {
                            mimeType: 'audio/webm;codecs=opus',
                            audioBitsPerSecond: 128000
                        });
                        
                        console.log('[LiveStream] Audio MediaRecorder created');
                        
                        let chunkCount = 0;
                        livestreamRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0 && livestreamWS && livestreamWS.readyState === WebSocket.OPEN) {
                                chunkCount++;
                                if (chunkCount % 50 == 0) {
                                    console.log(`[LiveStream] Sent ${chunkCount} audio chunks`);
                                }
                                livestreamWS.send(event.data);
                            }
                        };
                        
                        livestreamRecorder.start(50); // 50ms„Åî„Å®„Å´Audio„Éá„Éº„ÇøÈÄÅ‰ø°ÔºàÊúÄÈÅ©ÂÄ§Ôºâ
                        livestreamActive = true;
                        
                        console.log('[LiveStream] Audio streaming started (50ms chunks)');

                        document.getElementById('btn-livestream-start').disabled = true;
                        document.getElementById('btn-livestream-stop').disabled = false;
                        document.getElementById('btn-livestream-stop').style.background = '#e74c3c';
                        document.getElementById('livestream-status').textContent = 'üî¥ LIVE (Hybrid Mode)';
                        document.getElementById('livestream-status').style.background = '#ffebee';
                        document.getElementById('livestream-status').style.color = '#c62828';
                        
                    } catch (e) {
                        console.error('[LiveStream] MediaRecorder creation failed:', e);
                        alert('Failed to create audio recorder: ' + e.message);
                        stopLiveStream();
                        return;
                    }
                };
                
                livestreamWS.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        console.log('[LiveStream] Message from server:', msg);
                        
                        if (msg.type === 'progress') {
                            const statusEl = document.getElementById('livestream-status');
                            statusEl.textContent = `üî¥ LIVE - Item ${msg.current_index + 1}/${msg.total}`;
                        } else if (msg.type === 'completed') {
                            console.log('[LiveStream] Playlist completed');
                            stopLiveStream();
                        } else if (msg.error) {
                            console.error('[LiveStream] Server error:', msg.error);
                            alert('LiveStream error: ' + msg.error);
                            stopLiveStream();
                        }
                    } catch (e) {
                        console.log('[LiveStream] Non-JSON message:', event.data);
                    }
                };

                livestreamWS.onerror = (error) => {
                    console.error('[LiveStream] WebSocket error:', error);
                    alert(`WebSocket connection failed. Check console for details.`);
                    stopLiveStream();
                };

                livestreamWS.onclose = () => {
                    console.log('[LiveStream] WebSocket closed');
                    if (livestreamActive) {
                        stopLiveStream();
                    }
                };

            } catch (error) {
                console.error('[LiveStream] Start error:', error);
                alert('Failed to start livestream: ' + error.message);
            }
        }

        async function stopLiveStream() {
            if (livestreamRecorder && livestreamRecorder.state !== 'inactive') {
                livestreamRecorder.stop();
            }

            if (livestreamWS) {
                livestreamWS.close();
                livestreamWS = null;
            }

            try {
                await fetch('/livestream/stop', { method: 'POST' });
            } catch (error) {
                console.error('[LiveStream] Stop error:', error);
            }

            livestreamActive = false;
            livestreamRecorder = null;

            document.getElementById('btn-livestream-start').disabled = false;
            document.getElementById('btn-livestream-stop').disabled = true;
            document.getElementById('btn-livestream-stop').style.background = '#95a5a6';
            document.getElementById('livestream-status').textContent = 'Idle';
            document.getElementById('livestream-status').style.background = '#ecf0f1';
            document.getElementById('livestream-status').style.color = '#7f8c8d';
        }
    </script>
</body>
</html>